2023年9月10日 下午 5:14|22分钟 57秒

关键词:
组件、图标、进度条、自定义、颜色、程序、属性、单击、圆角、按钮、源码、环形、定时器、百分比数字、动画效果、页面效果、样式定义、样式文件

文字记录:
在上一节课，我们介绍了 icon 组件及如何自定义实现图标。这节课我们看一看 progress 组件以及如何实现一个环形进度条。在前端网络操作是异步的，一般都需要一个进度条。在很多应用中，我们经常可以看到环形的进度条，但是小程序原生的 progress 组件是一个从左到右的方形进度条，那么我们可不可以自实验一个环形的进度条？答案肯定是可以的，从原理上来讲，只要我们能够获知网络异步操作的以及汇聚出环形动画效果就可以实现了。

先看一下原生的组件，在这个代码中， show info 代表是否在进度条右侧显示百分比数字，一般不需要显示，因为进度条本身就标明了进度 ban 的 type 用于绑定 type 事件，所有可视的 view 组件都可以绑定 type 事件。其实属性列表里面没有显示标明。 stroke with 表示进度条的宽度，这是从前进方向上来看是宽度，从表象上看实际是高度。这个定义与 CSS 里面的 stroke 位置类似， person 是百分比在 0- 100 之间。

active mood 是动画停止后重新启动的模式，它有两个值， backwards 表示动画从头播， forwards 表示动画从上次结束的位置继续播放，它的默认值是backwards。在实践中，我们一般使用 forwards active 表示是否展示动画。与 show info 一样是布尔属性为真，只需要列上属性就可以了。如果想显示设置为false，需要写成 active 等于 false 这样的形式。 ban active end 用于绑定动画结束的事件，在动画结束时触发。

这里有两个颜色属性需要注意， active color 与 background color。默认情况下， active color 是 16 进制的， 09 B 07 background color 是 16 进制的。 EBE 小程序框架给了开发者修改的自由，但是这个颜色并不能随便使用。程序中的设计风格要保持一致性，这就涉及到了应用程序的设计规范问题。

上面的网址是微信设计规范网址，从上面的颜色规范中可以看到， 09 b 07 是默认的 active color 颜色。第一个 09 B 07 完成色，第二个 353535 称之为SEMI。大段儿说明文字，而且属于主要内容的，例如正文使用这个颜色。第三个 8888886 个 8 称之为gray，用于次要内容。第四个是链接色，第五个是警告词。纯黑色 black 一般用于主内容，浅色 light 一般用于时间戳与表单的缺醒值。

background 的 color 默认的颜色值1B，1B， 1B 不在上面的列表之内。在 VUI 组件库内，默认按钮的底色是 f two f to f two。这个颜色值与1B，1B， 1B 是很接近的。在使用的时候，我们要统一使用一致的颜色表示相同的含义。在这里我们将 background color 设置为 f to f to f to。

介绍完组件的属性，接下来我们看开发中经常会遇到哪些问题。第一个问题，如何实现一个下载文件并显示动态进度条的功能？有人在开发者社区问到这个问题，他想实现一个下载文件时显示动态进度条的功能。当看了文档以后，发现 PERCENT 属性必须设置为固定的值，例如80，但进度是一直变化的。该如何实现动态进度条？我们前面的示例代码基本就可以满足这个需求了。当启用 active 并将 active mood 设置为 forwards 后，动画就会随下载进度动起来。通过文件下载的总大小和已完成大小，可以实时计算出 person 的数值。需要注意的是， person 的属性是动态绑定的，每次变化后我们需要显示使用 set data 触发视图更新，不然动画是不动的。

我们再看第二个问题， progress 已产生的进度条如何设置圆角？在上面代码中包的 radius 属性可以设置圆角大小，默认值是0，但包括 radius 设置的是进度条外框的圆角大小，它无法设置内部已经前进的进度条圆角。有人说 progress 组件并不复杂，可以自己基于 view 组件实现一个，这也是一种办法，但如果实现一个像官方 progress 那样动画完备的组件也不是那么容易的。况且微信团队已经做好了一个，我们直接使用就是了。我们的目的是快速研发产品，没有必要在一个小组件上投入太多精力。

小程序与界面是基于浏览器内核渲染的，这也就是说所有官方组件都有它自身的 CSS 样式，或许我们可以通过调试功能查找出组件的 CSS 样式，直接在页面内进行样式重写。微信开发者工具只开放了 WXML 面板，屏蔽了 element 面板，没有办法直接查看 progress 组件的内部样式是什么，否则我们拿到内部样式以后就可以重写它了。当我们可以从微信开发者工具的本地源码中去寻找办法，在本地的组件样式。文件中放置的是官方小程序组件的样式定义，其中 WX progress inner bar 这个样式负责控制内部已经前进的进度条样式。我们只需要在页面内重写这个样式，给他一个包的 radius 圆角就可以了。但这个方法不是正规的路子，如果微信团队修改了内部央视的类名，那么这个配个方法就不好用了。但是对于小微团队和个人开发者来讲，其实也无所谓，能达到页面效果就好了。即使官方有变化，也不过是一个小样式，不影响产品的体验大区，重要的是快速迭代，不在小问题上浪费太多时间。

我们看下一个问题，已经加载完的进度条progress，如何单击某个按钮让它重新加载？有人说开启 Activo 动画后，当进度条完成以后，直接再设置一下 PERCENT 属性的值就可以实现。但是这个方法行不通，直接将 person 的再设置为 100 或其他数值，并不能让动画重新播放。

有人设想改变两次percent，借助 next TICK 或延时定时器分别在两个渲染周期里设置， next 是基础库 2. 2. 3 版本以上支持的，所以这位作者用了 WX 点 can i use 这个接口，判断能不能使用这个API，如果不能使用，则改用 set time out 设置一个严是定时器，先将 person 的数值设置为0，过来一个渲染周期或延时 17 毫秒再设置一次。这样就可以得到动画重新播放的效果了。

其实还有更简单的方法，每一次 set data 在底层调用 evaluate Javascript 这个底层函数，这个函数它用于逻辑层和视图层之间的通讯，它的执行本来就需要时间，因此直接调用两次 set data 也可以达到同样的效果。连续调用两次 set data 可能看起来不是那么优雅，但有时候看起来不是那么优雅的代码，可能才是最简单和有效的代码。

这里有一个问题留给你思考一下，为什么上面 set time out 设置的延时定时器要使用 17 毫秒？这作为一个作业答案，我们在下节课揭晓。我们看下一个问题，能否实现一个环形进度条？这也是开始我们提到的问题。官方的 progress 组件只支持常规场景从左向右显示进度，那么如果想实现一个环形进度条，怎么实现？用 CSS 绘制动画比较麻烦，可以用 canvas 绘制。使用 component 创建一个自定义组件，例如名字就叫 cycle progress。在这个组件的 w x m l 代码里放着一个 commerce 组件，并给它设置一个ID。这个 ID 为 run commerce 的 commerce 组件。它用于绘制上面的绿色源。灰色的圆圈是有一个灰色的底圆。 big cycle 加一个白色的稍微小一点的圆 little circle 组合出来的。它是由 CSS 样式实现的。在自定义组件中，通过一个 percent 的属性用于标识进度。这个属性与官方的 progress 组件具有相同的名称。这方面我们迁移代码和减少记忆的负担。

top Server 用于自动监听属性的变化。当进度增加时，调用 draw 函数绘制新增的绿色进度条。在做函数即后续调用的函数中计算出需要绘制的弧度，即使用 canvas 的弧度绘制 API Ark 进行绘制是实现环形效果的关键。 soccer progress 是一个独立的组件，在使用时需要在 JSON 配置文件中声明对组件的引用。 circle progress 是声明的名称，声明以后在 w x m l 中就可以把它当做标签使用了。在 button 触发的 JSON 函数中，模拟网络变化改变进度值就可以看到动画效果了。相关的代码在本课中都可以找到，大家看了源码就会知道。

实现自定义组件并不复杂，但有两点值得注意。第一点，当在自定义组件中使用 w x 点 create canvas content 创建画布的下文绘制对象时，需要在第二个参数处传递 this 对象，这样才是在组件中查找画布，不然只是在主页面中查找，也就是在引用它的页面中查找，这样就查找不到了。

第二点，使用 WX create select query 创建的对象的 select 方法，以 ID 查找组件对象时，如果在自定义组件中去，在查找前先调用一下它的 in 方法，把 this 对象传递进去，不然这个组件是查找不到的。默认查询也仅是在主页面中查找，不会涉及主页面中的子组件。

我们看下一个问题， progress 右边进度的百分比数字，它的颜色怎么设置？有两个方法，最简单直接的是直接使用内联样式。另外一种方法在第二个问题中解决圆角的时候，我们使用过了，在本地样式文件中找到类样式的名称，然后在页面中重写以后所有的 progress 组件百分比数字都是红色了，我们接着看下一个问题， progress 组件右侧百分比文字与左边离得太近了，可否增加一个边距？就是感觉进度条与百分比数字两者离得太近了。

想优化一下这其实社区上有人提的一个问题，这个问题很简单，解决方法同问题 5 直接修改样式就好了，并且这样的问题涉及到所有组件，最好也是修改全局的样式。最后给你留一个作业在问题 3 中，为什么 set time out 设置的延时定时器要使用 17 毫秒？如果你有答案，欢迎在下面留言。上节课作业时，从 icon front 点 cn 搜索两个图标，以自定义实现的方式用在自己的小程序项目中，我们看一下如何实现。

首先我们打开这个网站 icon front design，然后在主页上我们找到，我们随意找两个图标选的这个可以选择第一个，比如说爱心，第三个眼镜选择以后，在这个购物车这个图标里面有我们刚才选择的两个图标，然后选择添加至项目，这是我的 text 测试项目，点击确定。

在这块儿图标管里，我的项目里面可以看到我们刚才的项目text，然后这个地方是查看在线的字体源链接的，因为我们刚才添加了两个新的爱心和这个 3D 眼镜图标，所以这个地方这个代码是灰色的，我们需要单击更新代码，更新以后点此副自制代码，然后回到我们的小程序项目，在 WXSS 文件里面定义我们的类样式。好 copy 进来，把这行代码也复制一下。它可以复用， i cant afford，这个名字，我们是可以自定义的，用的别的名字也可以。这个地方是指定我们这个嵌入的字体的名称，这个名称和这个名称这两个名称要保持一致。然后我们给它一个默认的颜色，比如 colored in red，然后再给它一个大小奉特， size 等于40。

OK，那接下来我们再定义具体的图标代码，can，heart，这个要使用伪样式 before 让 content content 要使用 unicorn 的编码，我们从网站上可以看到这个编码编译的时候，这个地方可以有这个 UNICORN 编码。 copy 进来，然后再写另外一个图标的样式。 3D class 这个 Unicode 编码在这个外面，这个地方也可以复制，复制完以后我们 copy 到这个地方。好，前面这个部分这些字符要去掉。

okay，现在样式已经定义好了，我们在 MXML 里面去使用它，icon，然后 p class 等于，comfort，这是第一个图表，我们再 copy 一下，修改一下第二个图表，保存，然后预览一下效果。这就是我们刚才就从网站上下载的两个图标，自定义的图标。第二个图标后面有一个分号，这个分号是因为我们在这个定样式的时候，这个 content 里面这个地方分号把这个删掉，那这个分号就没有了，测试一下。

OK，那现在这种图标是我们从网站上直接搜索下载使用的，如果这个图标不能满足我们的需求，那么我们有没有办法去修改它呢？前面我们提到了有一个在线的 Photoshop 编辑工具，就是这个 UUPOOP . com，这是一个在线的 Photoshop 编辑工具，用它我们可以进行一些矢量图片的一些编辑，不需要安装再打开就能使用，的确很方便。

在编辑之前，我们需要首先把我们要编辑的图标下载到本地，比如说这个爱心图标，我们单这个下载按钮，选择 s v g 格式下载保存到桌面上。现在我们打开这个 Photoshop 在线工具，选择文件打开，然后选择桌面上我们刚才保存的爱心这个图表，这个图标大概是这个样子，这个图标我们其实可以看一下，它是一个文本文件，我们看一下这个图标，这是我们刚才下载的图标，我们可以看一下它的源码，它本身是一个可以查看的一个文本文件。

这里面就是有一些路径信息、坐标信息，还有一些颜色信息等等这些，那我们可以使用工具直接打开，当然使用其他的矢量编辑工具也是可以的。嗯，我们可以选择这个本身这个层，然后在这个信息里面有一个图层，这地方可以改变它的颜色，然后我们还可以添加自己的图形，比如说画一个矩形，okay，然后还可以改变它的颜色。

OK，简单编辑一下，作为一个实例，现在我们假设我们这个图表已经编辑好了，我们把它保存到本地文件，选择文件导出，这里面有个 s v g 格式，我们选择这个格式高度高宽我们设置小一点，比如 200 就可以了。然后保存，也选择桌面那个位置，已经保存好了，现在我们回到 icon phone 的这个网站上，这个爱心按钮，我们单击编辑按钮，在这个地方有一个单击上传替换icon，我们选择这个按钮，然后选择我们刚才保存的图标。

先来看一下我们刚才对这个图标的更改，现在已经更新上来了，我们可以选择这个具体的每年的一些几何图形，然后对它有一个颜色旋转、位移等等这些修改，简单的修改在这个界面上进行修改，完成以后我们点击保存，这个时候我们看到这个字体源的代码现在又是灰色的，我们再单击更新一下，然后复制代码。

这个时候我们看这个缩略图，这个图标它已经变化了，就是我们修改之后的样子，我们修改了复制这个代码以后，我们回到我们的小程序项目当中，把我们的字体元这一部分， phoneface 这部分代码给它剃掉，然后保存重音。预览，这个时候再看这个图标，就是我们修改之后的图标了，这个颜色红色是因为我们在样式里面指定的颜色，我们还可以每个图标指定它本身自己的颜色，比如说这 color 等于green，然后保存预览。现在我们看到这个图标颜色也变成绿色，OK，这就是自定义图标的实现。

好，这节课就讲到这里。这节课主要介绍了小程序组件progress，即如何实现一个环形进度条。下节课我们介绍 rich text 富文本组件。这节课给你留了一个作业在问题 3 当中，为什么 set time out 设置的延时挺时器一定要使用 17 毫秒？如果你有答案，欢迎在下面留言。

