# 小程序的优化

[toc]

## 一、启动小程序

### （1）小程序的启动流程

![小程序启动流程](./photos/014-小程序启动流程.png)

### （2）代码包的下载

- 在某个小程序第一次启动时，微信需要下载小程序代码包。此后，如果小程序代码包未更新且还被保留在缓存中，则下载小程序代码包的步骤会被跳过。

- 下载到的小程序代码包不是小程序的源代码，而是编译、压缩、打包之后的代码包。

  代码包大小可以在开发者工具的“详情”栏中找到。

- 控制代码包大小有助于减少小程序的启动时间。

  对低于1MB的代码包，其下载时间可以控制在929ms（iOS）、1500ms（Android）内。

控制代码包大小的方法：

1. 精简代码，去掉不必要的WXML结构和未使用的WXSS定义。
2. 减少在代码包中直接嵌入的资源文件。
3. 压缩图片，使用适当的图片格式。

如果小程序比较复杂，优化后的代码总量可能仍然比较大，此时可以采用分包加载的方式进行优化。

### （3）分包加载流程

小程序的代码包可以被划分为几个：

- 一个是“主包”，包含小程序启动时会马上打开的页面代码和相关资源；
- 其余是“分包”，包含其余的代码和资源。

小程序启动时，只需要先将主包下载完成，就可以立刻启动小程序。这样就可以显著降低小程序代码包的下载时间。

一个支持分包的小程序目录结构，代码根目录下有“packageA”和“packageB”两个子目录（它们的名字需要在app.json中声明）：

![小程序分包的目录结构](./photos/015-小程序分包的目录结构.png)

分包的`app.json`代码：

```
{
  "pages":[
    "pages/index",
    "pages/logs"
  ],
  "subPackages": [
    {
      "root": "packageA",
      "pages": [
        "pages/cat",
        "pages/dog"
      ]
    }, {
      "root": "packageB",
      "pages": [
        "pages/apple",
        "pages/banana"
      ]
    }
  ]
}
```

在小程序启动时，“packageA”和“packageB”两个子目录的内容不会马上被下载下来，只有主包的内容才会被下载。

> 利用这个特性就可以显著降低初始启动时的下载时间。

使用分包时需要注意代码和资源文件目录的划分。启动时需要访问的页面及其依赖的资源文件应放在主包中。

### （4）代码包的加载

1. 小程序的代码包被下载（或从缓存中读取）完成后，小程序的代码会被加载到适当的线程中执行。

2. 所有app.js、页面所在的JS文件和所有其他被require的JS文件会被自动执行一次，小程序基础库会完成所有页面的注册。

   > 在小程序代码调用Page构造器的时候，小程序基础库会记录页面的基础信息，如初始数据（data）、方法等。

3. 如果一个页面被多次创建，并不会使得这个页面所在的JS文件被执行多次，而仅仅是根据初始数据多生成了一个页面实例（this），在页面JS文件中直接定义的变量，在所有这个页面的实例间是共享的。

例如，若从页面A使用wx.navigateTo跳转到页面B，再使用wx.navigateTo跳转到页面A，此时页面栈中有三个页面：A、B、A。

这时两个A页面的实例将共享它的JS文件中Page构造器以外直接定义的变量。

> 有经验的开发者可以利用这个特性，但一些开发者也会错误地共享出一些变量，因而使用时要小心。

```javascript
console.log('加载 page.js')
var count = 0
Page({
  onLoad: function() {
    count += 1
    console.log('第 ' + count + ' 次启动这个页面')
  }
})
```

如果在page.js中加入这段代码，则在小程序代码包加载阶段就会在控制台中输出一段提示语，并在每次页面被创建后输出这是这个页面第几次被创建。

### （5）初始化小程序的首页

在小程序代码包加载完毕后，小程序基础库会根据启动路径选择一个页面来启动。这时会根据页面路径和初始数据创建一个新页面。