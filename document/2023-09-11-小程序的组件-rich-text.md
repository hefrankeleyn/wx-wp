# 小程序组件：rich-text（富文本组件）

[toc]



## 一、说明

[rich-text官方文档](https://developers.weixin.qq.com/miniprogram/dev/component/rich-text.html)。

将富文本渲染到页面上。

- 认识`rich-text`组件；
- 如何单击预览它的节点图片并保存；

## 二、概念描述

在富文本组件 `rich-text` 中，节点的事件是被屏蔽的，例如节点里面的图片，它的单击时间我们是不能监听的。那么在这种情况下，我们如何实现单机预览节点图片并保存它们？

```
<rich-text space="emsp" nodes="{{nodes}}" bindtap=“tap"></rich-text>
```

上面这个`rich-text` 组件，只有两个属性，`space`与 `nodes`。

- `space` 代表空格

space 代表空格策略，控制中文空格显示的大小，有三种值，在中文环境直接取`emsp`就好。

- `nodes`  array/string，节点列表/HTML String。

如果是字符串的话会影响性能，所以一般情况下我们都是数组。在 `nodes`的属性中有这样一些子属性：

-  `name` 标签名，表示节点名称，例如p，div，span， image 等等。大部分 html 标签都受支持，就连 HTML5 不太常用的ruby标签也支持。 

  > ruby 是一个在字符上方显示东亚字符拼音文本的标签。这个 ruby 并不是那个编程语言，而是 html 里面的一个标签。

- `attrs`  表示节点的属性，是定义在HTML标签上的属性。例如，`img`标签的`src`、`width`、`height`属性。

- `children` 子节点列表，是一个数组。type代表节点类型，共用两种， node 与text，默认是node，可以不写。

  当类型是 node时，有 children 属性，如果是text，则只有一个 text 属性。 text 的节点只能包括纯文本。node 是一个数组，数组中每个元素都可以是复合的 node 节点，也可以是末节的 text 节点。这是一个树状结构，简单分辨节点类型的方法就是看节点有没有 name 属性， name 代表标签名称，有 name 代表是标签节点，如果没有，并且 type 属性为text，代表的是简单的文本节点。当是 text 节点时，它代表的是最基本的文本，没有样式，它所有的样都是来自父节点的设定。在 Vue 或 WXML 的模板中，它类似于带花括号的message。这样的一个纯文节点，解析到虚拟DOM列表中都是一个独立的节点，都是可以直接改变内容的。如果不是 test 节点，必须有一个`name`属性，例如一个`img`节点，这相当于是一个 `img`HTML标签，可以翻译为对等的 HTML 代码。从 MDN 文档上可以查到 img 标签还有其他属性，比如 width、 height、alt、ismap、longdesc、usemap等。

**不受信的HTML节点会被移除。**

这些 HTML 定义的属性原则上都可以在 node 里定义。但是在使用之前，我们最好先查一下微信小程序 rich-text 组件的文档，里面有一个受信任的 html 节点及属性列表，看看我们使用的属性在不在支持的范围里。如果使用了不受信任的 html 节点，该节点及所有子节点将会被移除。不是忽略，而是被移除，这可能会造成不易被发现的bug。

## 三、使用`rich-text`标签遇到的问题

### （1）如何预览保存 rich text 富文本组件中的图片

如果可以拿到单击事件，以事件的 currentTarge 取到目标组件，再判断目标组件是不是image，如果是的话，取它的 src属性，拿到图片的链接，可以实现预览和下载图片了。但是 rich-text 中的所有节点都是屏蔽单击事件，所以通过添加网页 click 事件在对事件对象进行处理。这个方法是行不通的，但我们仍然可以在 rich-text 组件上添加 tap 事件。

在事件函数中使用 `wx.previewImage` 这个接口预览图片，然后选择需要的图片，在下载预览之前，我们需要遍历 rich-text 中的 nodes 数据，将所有图片地址预先取出来，当单击 rich-text 的富文本组件时，触发预览，在 tap 事件句柄中，事件对象 e 是一个 TouchEvent 对象，使用它的pageX、pageY  属性还可以取到用户大概单击了什么位置。如果以位置可以判断出图片是哪一张，就可以在调用 `wx.previewImage`预览图片时作为第一个参数传递进去，这样就可以实现指定图片的预览与下载了。如果不能确定，取第一张就可以了。

```
<rich-text space="emsp" nodes="{{nodes}}" bindtap="tap"></rich-text>
```

这个实例代码，nodes 绑定的这个 nodes 数据在我们 js里面，是在这个 data 里面声明和定自定义的声明定义的。然后我们在wxml里面还通过bindtap绑定了一个JavaScript函数tap。

```javascript
  tap(e) {
    let urls = this.data.urls
    wx.previewImage({
      current: urls[0],
      urls: urls
    })
  },
```

这块是调用了 `wx.previewImage`这样进行预览，预览以后可以下载。

我们单击以后这个图片是可以，当你以后这个图片是可以按预览的，然后可以左右滑动，因为这个是开发者工具，所以它这个滑动不是很方便。然后在预览之前，我们其实是需要一个 urls 的这样一个数组，这个数组开始的时候它是空的，我们是在 onReady 周期函数中对这个 nodes 数据进行了一个遍历。首先判断它这个节点 name 是不是image，再看这个它的属性有没有src，如果有的话把它推到这个数组里面去，然后拿到这个数组放在data 里面那个位置，这样的话我们在单击的时候就可以使用这个图片数组这些数据了。

### （2）在富文本 rich-text 中，如何解决图片之间的间隙问题？

如果 rich-text 中有多张图片，上下图片间会有间隙。这是样式问题，在 HTM5 开发中，我们可以通过查找img 标签，然后修改它的样式，通过这样的方式可以解决这个问题，但是在小程序当中不可以，小程序的 rich-text 是通过 Web component 实现的，它不允许外部修改内部的 image 元素的样式。

我们可以直接修改nodes数据中的 img样式，给它添加两个内联样式，这个缝隙是行内容引起的，通过设置元素为块元素并设置字体为0，图片间的间隙就没有。

如果每个 img 节点都添加内联样式比较麻烦，还可以在 wxss 文件中声明一个通用的类，然后在每一个 img 节点上添加这个类样式名称，这样也可以。

```
style: 'width:100%;font-size:0;display:block;'
```

可以简单的通过给它加一个 style 样式，把上面这个除掉，保存一下，现在这个两个图片之间的这个白色的缝隙就没有了。

还可以通过添加一个类样式：

```
.img {
   font-size: 0;
   display: block;
}
```

然后我们在代码里面将那个内联样式去掉，然后加一个`class: 'img'`。

### （3）富文本 rich text 里面怎么插入 ad 广告标签？

如何将 hmtl 文本直接解析并呈现？有人说 Notes 数据格式需要手动创建与维护比较麻烦，有没有办法直接将 html 源码解析并呈现？

有一个开源组件可以直接解析 HTML源码，并在小程序中直接呈现。

- 下载源码；
- 把`parser`文件夹放到项目中的适当位置；
- 在 JSON 配置文件中引用组件；
- 准备好数据；
- 在 WXML 中使用

这个组件支持给每个特定的 HTML 标签定义它自己的样式。这个功能是通过 tag-style 属性完成的。

当定义了 image 的无间隙样式，所以在效果中上下图片之间已经没有间隙了，这也算是问题 2 的另一种解决方案。

Parser 这个组件的一个源码的一个目录。

> https://github.com/jin-yufeng/mp-html.git

第一步，在这个 json 里面进行引入，

```
{
  "usingComponents": {
    "parser":"../../components/parser/parser"
  }
}
```

第二步，是准备它的数据



通过 Parser 的源码可以看到它对 html 源码文本的解析是通过一个个字符去解析的，例如 comment 是用于解析注释的，以这种解析确定 tag 在拿到 tag 单词以后，再通过有限的 switch 遍历生成对应的 Notes 数据。

Parser 组件支持的标签列表是在源码内部写死的，它不能解析的 tag 它一定也不能呈现，这一点也说明软件都是有边界的。在这个组件内部有一个名为 trace 的定义组件，在这个组件中对上一步生成的弄资数据做了绑定渲染。 Passer 的 NODE 数据与 rich text Notes 并不是对等的，它是大于后者的。 Passer 不仅支持 rich text，还支持audio、 video 等标签，并且从源码中可以看到它还支持递归，也就是说它支持 div 容器的嵌套。从源码中我们还看到了 ad 的影子，这说明它还支持广告。将 unit-ad 传递给它，它就能解析，比如呈现出一个 banner 广告，该功能具体是通过 ad 这个小程序组件实现的，



pass 组件这个 labs 这个目录，这里面有一个 mp 开头这个文件，在这个里文件我们可以看到刚才我们提到的。

comment 这个函数，它就是为了处理注释的，在这个里面它提取的是一些关于注释的一些特征。



还有问题一，关于单机图片放大下载问题，通过这个组件也可以完美的得到解决，并且不需要预先从 nodes 数据中解析 urls，因为 passer 这个它对 image 的解析和呈现是通过小程序的 image 组件实现的，所以它原生支持单机放大预览与下载。

从源码可以看出，parser原生支持图片的放大预览，并且单击时还向外层派发了一个 imgtap事件。我们在使用这个组件时，可以添加一个对imgtap事件的监听，在运行时就能拿到被单击图片的网址了。



绑定了这个 band IM image type，绑定了这个 IMG type 事件在这个，这是我们绑定的 js 函数，我们看一下这个 js 函数里面只是一个简单的一个 console log 的一个打印这个图片的网址，这个本身这个 MG type 这个时间它是在这个 passer 组件里面。



Passer 这个开源组件不依赖于第三方库，自实现了词法解析和DOM重建，代码量也不大，很值得研究学习。有了这个技巧，我们甚至可以设置一门编程语言自定义语法，写一个编译解析，编译自己语言写的程序，这样都是可以的。

与 Parser 组件类似的开源项目还有一个 wxpass 开源项目，它不仅支持解析 html，还支持解析Markdown内容。有人说 Parser 是基于 wxpass 二次开发的。

> wxpaas，这个开源项目也有值得研究的价值。

## 四、作业：使用parsser组件能渲染不支持的html属性吗

在官方的 rich-text 组件中，如果节点有不支持的 html 属性，节点及子节点都会被被移除，那么相同的 notes节点数据如果改用 passer 组件去渲染的话，可以渲染出来吗？

答案是不行的，因为我们从源码中可以看到， Parser 自定义组件的功能也是有限的，对于它本身不能渲染的标签，在内部也是交给 rich-text 这个小程序原生的这个组件去渲染的。所以说如果说有 rich-text 本身不支持的节点，那么你交给 Parser 也是一样的，也是不行。
